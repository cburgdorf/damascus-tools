#!/usr/bin/env python

from prompt_toolkit import PromptSession
from prompt_toolkit.history import FileHistory
from os.path import expanduser

from os import system
import sys
import nrepl


def send2REPL(conn, clojureCode):
    conn.write({"op": "eval", "code": clojureCode})
    print(conn.read()['value'])


# program execution starts here
if len(sys.argv) == 1:
    nreplPort = '1667'
else:
    nreplPort = sys.argv[1]

system(f'bb nrepl-server {nreplPort} &')

myPromptSession = PromptSession(
    history=FileHistory(expanduser('~/.bbc_history')))

conn = nrepl.connect(f"nrepl://localhost:{nreplPort}")

while True:
    userInput = myPromptSession.prompt('Enter command:\n')
    send2REPL(conn, userInput)
